name: Deploy Backend
on:
  push:
    branches: [ master ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: mvn -f mep-backend/pom.xml clean package -DskipTests -X
    - name: Deploy to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.BACKEND_SERVER_USER }}
        password: ${{ secrets.BACKEND_SERVER_PASSWORD }}
        source: "mep-backend/target/*.jar"
        target: "~/apps/mep-backend"
    - name: Restart Backend Service
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.BACKEND_SERVER_USER }}
        password: ${{ secrets.BACKEND_SERVER_PASSWORD }}
        script: |
          # Try to load environment
          for f in /etc/profile ~/.profile ~/.bash_profile ~/.bashrc; do
            [ -f "$f" ] && . "$f" && echo "Sourced $f"
          done
          
          export PATH=$PATH:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
          
          # Find PM2
          PM2_BIN=$(command -v pm2 || which pm2 || find /usr/local/bin /usr/bin /opt -name pm2 -type f 2>/dev/null | head -n 1)
          
          if [ -z "$PM2_BIN" ]; then
            echo "PM2 not found in standard paths. Searching HOME..."
            PM2_BIN=$(find $HOME -name pm2 -type f 2>/dev/null | head -n 1)
          fi
          
          if [ -z "$PM2_BIN" ]; then
            echo "CRITICAL: PM2 not found. Printing PATH and common dirs:"
            echo "PATH: $PATH"
            ls -l /usr/local/bin/pm2 /usr/bin/pm2 2>/dev/null || true
            PM2_BIN="pm2" # Fallback to hope for the best
          fi
          
          echo "Using PM2 at: $PM2_BIN"
          
          $PM2_BIN delete mep-backend || true
          $PM2_BIN start "java -jar -Dserver.port=8085 ~/apps/mep-backend/mep-backend/target/backend-0.0.1-SNAPSHOT.jar" --name mep-backend
