name: Deploy Backend
on:
  push:
    branches: [ master ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: mvn -f mep-backend/pom.xml clean package -DskipTests -X
    - name: Deploy to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.BACKEND_SERVER_USER }}
        password: ${{ secrets.BACKEND_SERVER_PASSWORD }}
        source: "mep-backend/target/*.jar"
        target: "~/apps/mep-backend"
    - name: Restart Backend Service
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.BACKEND_SERVER_USER }}
        password: ${{ secrets.BACKEND_SERVER_PASSWORD }}
        script: |
          # Robust PATH setup
          export PATH=$PATH:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$HOME/.local/bin:$HOME/bin
          source ~/.profile || true
          source ~/.bashrc || true
          
          # Find pm2 absolute path
          PM2_BIN=$(which pm2 || find /usr/local/bin /usr/bin $HOME/.npm-global/bin $HOME/.nvm -name pm2 -type f 2>/dev/null | head -n 1)
          if [ -z "$PM2_BIN" ]; then PM2_BIN="pm2"; fi
          
          $PM2_BIN delete mep-backend || true
          $PM2_BIN start "java -jar -Dserver.port=8085 ~/apps/mep-backend/mep-backend/target/backend-0.0.1-SNAPSHOT.jar" --name mep-backend
