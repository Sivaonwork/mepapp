name: Deploy Backend
on:
  push:
    branches: [ master ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: mvn -f mep-backend/pom.xml clean package -DskipTests -X
    - name: Deploy to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.BACKEND_SERVER_USER }}
        password: ${{ secrets.BACKEND_SERVER_PASSWORD }}
        source: "mep-backend/target/*.jar"
        target: "~/apps/mep-backend"
    - name: Restart Backend Service
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.BACKEND_SERVER_USER }}
        password: ${{ secrets.BACKEND_SERVER_PASSWORD }}
        script: |
          # Try to load environment
          for f in /etc/profile ~/.profile ~/.bash_profile ~/.bashrc; do
            [ -f "$f" ] && . "$f" && echo "Sourced $f"
          done
          
          export PATH=$PATH:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
          
          # Find PM2
          PM2_BIN=$(command -v pm2 || which pm2 || find /usr/local/bin /usr/bin /opt -name pm2 -type f 2>/dev/null | head -n 1)
          
          if [ -n "$PM2_BIN" ]; then
            echo "Using PM2 at: $PM2_BIN"
            $PM2_BIN delete mep-backend || true
            $PM2_BIN start "java -jar -Dserver.port=8085 ~/apps/mep-backend/mep-backend/target/backend-0.0.1-SNAPSHOT.jar" --name mep-backend
          else
            echo "PM2 not found. Falling back to nohup."
            # Kill existing process on port 8085
            fuser -k 8085/tcp || true
            sleep 2
            nohup java -jar -Dserver.port=8085 ~/apps/mep-backend/mep-backend/target/backend-0.0.1-SNAPSHOT.jar > ~/apps/mep-backend/backend.log 2>&1 &
            echo "Backend started with nohup."
          fi
